name: Deploy to Main

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type DEPLOY to confirm'
        required: true
        type: string

env:
  FROM_BRANCH: dev
  TO_BRANCH: main

jobs:
  check-ci-status:
    name: Validate CI on Dev
    runs-on: self-hosted

    steps:
      - name: Ensure confirmation
        if: ${{ inputs.confirm != 'DEPLOY' }}
        run: |
          echo "❌ You must type DEPLOY to trigger deployment"
          exit 1

      - name: Verify latest workflow on Dev is green
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const branch = process.env.FROM_BRANCH;

            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner, repo,
              per_page: 10,
              branch,
            });

            const latest = runs.data.workflow_runs.find(run =>
              run.head_branch === branch
            );

            if (!latest) {
              core.setFailed(`❌ No workflow runs found on ${branch}`);
            }

            if (latest.conclusion !== "success") {
              core.setFailed(`❌ Latest CI on ${branch} failed or not finished`);
            }

            core.info(`✅ CI on ${branch} succeeded. Proceeding...`);

  merge:
    name: Merge Dev → Main
    runs-on: self-hosted
    needs: check-ci-status

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Merge branch
        uses: devmasx/merge-branch@v2.7.0
        with:
          type: now
          from_branch: ${{ env.FROM_BRANCH }}
          target_branch: ${{ env.TO_BRANCH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deployment triggered
        run: echo "✅ Merged dev → main"
